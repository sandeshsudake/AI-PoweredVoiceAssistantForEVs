<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EV Voice Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        /* Sidebar styles */
        #drowsySidebar {
          position: fixed;
          top: 0; right: 0;
          width: 420px;
          max-width: 95vw;
          height: 100vh;
          background: var(--container-bg, #fff);
          box-shadow: -4px 0 24px #b3c6e7a8;
          z-index: 100;
          padding: 2rem 1.2rem 1.2rem 1.2rem;
          transition: transform 0.4s cubic-bezier(.7,0,.2,1);
          transform: translateX(0);
          overflow-y: auto;
        }
        #drowsySidebar.closed {
          transform: translateX(100%);
        }
        #sidebarToggleBtn {
          position: fixed;
          top: 30px; right: 30px;
          z-index: 110;
          background: var(--btn-gradient, #4771e3);
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 48px; height: 48px;
          font-size: 1.7rem;
          box-shadow: 0 2px 12px #b3c6e7a8;
          cursor: pointer;
          transition: background 0.3s;
        }
        @media (max-width: 600px) {
          #drowsySidebar { width: 98vw; padding: 1rem 0.5rem; }
          #sidebarToggleBtn { right: 10px; top: 10px; }
        }
    </style>
    <!-- Drowsiness Detection dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
<div class="theme-toggle" aria-label="Toggle light/dark theme">
    <label>
        <span class="theme-icon" aria-hidden="true" style="color:#4797e6;">üåô</span>
        <span class="toggle-switch">
        <input type="checkbox" id="themeSwitch" aria-checked="false" />
        <span class="toggle-thumb"></span>
      </span>
        <span class="theme-icon" aria-hidden="true" style="color:#f1b429;">‚òÄÔ∏è</span>
    </label>
</div>

<!-- Sidebar Toggle Button -->
<button id="sidebarToggleBtn" title="Show/Hide Drowsiness Detection" aria-label="Toggle Drowsiness Sidebar">üëÅÔ∏è</button>

<!-- Drowsiness Detection Sidebar -->
<aside id="drowsySidebar" class="closed" aria-label="Drowsiness Detection Sidebar">
    <section id="drowsiness-section">
        <h3>Drowsiness Detection</h3>
        <video id="inputVideo" autoplay playsinline style="width:400px; border:1px solid black;"></video>
        <canvas id="outputCanvas" width="400" height="300"></canvas>
        <p id="status" style="font-size: 18px; font-weight: bold;">Status: Monitoring...</p>
        <p id="earDisplay" style="font-size: 14px; color: #666;">EAR: Calculating...</p>
        <p style="font-size: 12px; color: #999;">Close your eyes for 0.5 seconds to trigger alarm</p>
        <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
    </section>
</aside>

<main class="container" role="main" aria-label="EV Voice Assistant">
    <h2 th:text="${welcomeMessage}">EV Voice Assistant</h2>
    <button id="micBtn" title="Tap and speak" aria-label="Start voice input" type="button" aria-pressed="false">üé§</button>
    <section id="responseDiv" aria-live="polite" aria-atomic="true" role="region" tabindex="0" class="response-area">
        Say "Your commands" ...
    </section>


    <section class="broadcast-board">
        <h3>EV Community Broadcast Board</h3>

        <div id="broadcastError" style="color:red; margin-bottom:10px;"></div>

        <form id="broadcastForm">
            <input type="text" id="broadcastInput" maxlength="120" placeholder="Share a quick update (e.g. charger status, traffic)..." autocomplete="off" />
            <button type="submit" id="broadcastPostBtn">Post</button>
        </form>
        <ul id="broadcastList"></ul>
    </section>
</main>

<script th:src="@{/js/voice-assistant.js}"></script>
<script th:src="@{/js/drowsiness.js}"></script>
<script>
    // Sidebar toggle logic
    const sidebar = document.getElementById('drowsySidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    toggleBtn.onclick = function() {
      sidebar.classList.toggle('closed');
    };


   // Community Broadcast Board with backend API
// Community Broadcast Board with backend API
const form = document.getElementById('broadcastForm');
const input = document.getElementById('broadcastInput');
const list = document.getElementById('broadcastList');
const errorDiv = document.getElementById('broadcastError');

// Helper: fetch with timeout (default 5s)
function fetchWithTimeout(resource, options = {}, timeout = 5000) {
  return Promise.race([
    fetch(resource, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Request timed out')), timeout)
    )
  ]);
}

async function fetchNotes() {
  errorDiv.textContent = '';
  try {
    const res = await fetchWithTimeout('/api/broadcast', {}, 5000);
    if (!res.ok) {
      const data = await res.json();
      errorDiv.textContent = data.error || 'Error fetching posts.';
      list.innerHTML = '';
      return;
    }
    const notes = await res.json();
    renderNotes(notes);
  } catch (e) {
    errorDiv.textContent = e.message === 'Request timed out'
      ? 'Server is not responding. Please try again later.'
      : 'Network error. Please try again later.';
    list.innerHTML = '';
  }
}

function renderNotes(notes) {
  list.innerHTML = notes.map(note =>
    `<li class="broadcast-note" data-id="${note.id}">
      <span class="note-text">${note.content}</span>
      <button onclick="deleteNote(${note.id})" title="Delete" class="delete-btn" aria-label="Delete post">üóëÔ∏è</button>
    </li>`
  ).join('');
}

form.onsubmit = async e => {
  e.preventDefault();
  errorDiv.textContent = '';
  const val = input.value.trim();
  if (val) {
    try {
      const res = await fetchWithTimeout('/api/broadcast', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content: val })
      }, 5000);
      if (!res.ok) {
        const data = await res.json();
        errorDiv.textContent = data.error || 'Error adding post.';
      } else {
        input.value = '';
        fetchNotes();
      }
    } catch (e) {
      errorDiv.textContent = e.message === 'Request timed out'
        ? 'Server is not responding. Please try again later.'
        : 'Network error. Please try again later.';
    }
  }
};

window.deleteNote = async function(id) {
  errorDiv.textContent = '';
  try {
    const res = await fetchWithTimeout(`/api/broadcast/${id}`, { method: 'DELETE' }, 5000);
    if (!res.ok) {
      const data = await res.json();
      errorDiv.textContent = data.error || 'Error deleting post.';
    } else {
      fetchNotes();
    }
  } catch (e) {
    errorDiv.textContent = e.message === 'Request timed out'
      ? 'Server is not responding. Please try again later.'
      : 'Network error. Please try again later.';
  }
};

fetchNotes();
</script>
</body>
</html>